import pandas as pd
from fuzzywuzzy import fuzz

# Load both Excel files
sheet1 = pd.read_excel('sheet1.xlsx')
sheet2 = pd.read_excel('sheet2.xlsx')

def fuzzy_match(str1, str2):
    return fuzz.ratio(str(str1).lower(), str(str2).lower()) >= 90

# Initialize Match column
sheet1['Match'] = None

# 4. Match Account_Hosp_Id
hosp_matches = pd.merge(sheet1, sheet2, 
                        left_on='Account_Hosp_Id_r', 
                        right_on='Account_Hosp_Id',
                        how='inner')
sheet1.loc[hosp_matches.index, 'Match'] = hosp_matches['Account_Hosp_Id']

# 5. Match Account_Mco__Id for unmatched rows
remaining = sheet1[sheet1['Match'].isna()]
mco_matches = pd.merge(remaining, sheet2,
                      left_on='Account_Mco__Id_r',
                      right_on='Account_Mco__Id',
                      how='inner')
sheet1.loc[mco_matches.index, 'Match'] = mco_matches['Account_Mco__Id']

# 6. Fuzzy match Website/DomainEmail
remaining = sheet1[sheet1['Match'].isna()]
for idx, row in remaining.iterrows():
    matches = sheet2[sheet2.apply(lambda x: fuzzy_match(x['Website'], row['DomainEmail']) or 
                                 fuzzy_match(x['Website_2'], row['DomainEmail']), axis=1)]
    if not matches.empty:
        sheet1.at[idx, 'Match'] = matches.iloc[0]['Website']

# 7. Fuzzy match Name/Account_Name
remaining = sheet1[sheet1['Match'].isna()]
for idx, row in remaining.iterrows():
    matches = sheet2[sheet2.apply(lambda x: fuzzy_match(x['Name'], row['Account_Name']), axis=1)]
    if not matches.empty:
        sheet1.at[idx, 'Match'] = matches.iloc[0]['Name']

# 8. Fuzzy match Name/Company
remaining = sheet1[sheet1['Match'].isna()]
for idx, row in remaining.iterrows():
    matches = sheet2[sheet2.apply(lambda x: fuzzy_match(x['Name'], row['Company']), axis=1)]
    if not matches.empty:
        sheet1.at[idx, 'Match'] = matches.iloc[0]['Name']

# Save results
sheet1.to_excel('matched_output.xlsx', index=False)
