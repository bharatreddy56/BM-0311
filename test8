import pandas as pd
from fuzzywuzzy import fuzz

# Read both Excel files
sheet1 = pd.read_excel('sheet1.xlsx')
sheet2 = pd.read_excel('sheet2.xlsx')

# Convert relevant columns to string type and clean data
for df in [sheet1, sheet2]:
    df['Account_Hosp_Id_r'] = df['Account_Hosp_Id_r'].astype(str)
    df['Account_Mco__Id_r'] = df['Account_Mco__Id_r'].astype(str)
    df['DomainEmail'] = df['DomainEmail'].str.lower().str.strip()

sheet2['Account_Hosp_Id'] = sheet2['Account_Hosp_Id'].astype(str)
sheet2['Account_Mco__Id'] = sheet2['Account_Mco__Id'].astype(str)
sheet2['Website'] = sheet2['Website'].str.lower().str.strip()
sheet2['Name'] = sheet2['Name'].str.lower().str.strip()

# Initialize Match column
sheet1['Match'] = None

def get_best_match(row, sheet2, column1, column2, threshold=90):
    matches = []
    for _, s2_row in sheet2.iterrows():
        if pd.isna(s2_row[column1]) or pd.isna(row[column2]):
            continue
        if fuzz.ratio(str(s2_row[column1]).lower(), str(row[column2]).lower()) >= threshold:
            matches.append((s2_row['Id'], f"name:{s2_row['Name']}"))
    return matches[0][0] if matches else None

# Matching logic
for idx, row in sheet1.iterrows():
    # Check Account_Hosp_Id first
    hosp_matches = sheet2[sheet2['Account_Hosp_Id'] == row['Account_Hosp_Id_r']]
    if not hosp_matches.empty:
        sheet1.at[idx, 'Match'] = hosp_matches.iloc[0]['Id']
        continue
        
    # Check Account_Mco__Id
    mco_matches = sheet2[sheet2['Account_Mco__Id'] == row['Account_Mco__Id_r']]
    if not mco_matches.empty:
        sheet1.at[idx, 'Match'] = mco_matches.iloc[0]['Id']
        continue
        
    # Check Website vs DomainEmail
    website_matches = sheet2[sheet2['Website'] == row['DomainEmail']]
    if not website_matches.empty:
        sheet1.at[idx, 'Match'] = website_matches.iloc[0]['Id']
        continue
        
    # Fuzzy match Name vs Account_Name
    name_match = get_best_match(row, sheet2, 'Name', 'Account_Name')
    if name_match:
        sheet1.at[idx, 'Match'] = name_match
        continue
        
    # Fuzzy match Name vs Company
    company_match = get_best_match(row, sheet2, 'Name', 'Company')
    if company_match:
        sheet1.at[idx, 'Match'] = company_match

# Save output
sheet1.to_excel('matched_output.xlsx', index=False)
